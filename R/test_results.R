#' View (and save) `test_runtests()` output
#'
#' Use `view_test_results()` to preview test results generated by `save_test_results()`
#' (saving should only ever be done in a GHA workflow).
#'
#' @param test_runtests_output output from `test_runtests()`.
#' @param gha_branch_name an identifier determined by the GHA workflow
#' @param pr_number the pull request number.
#' @param username the username of the github profile.
#' @rdname test-results
#' @export
save_test_results <- function(test_runtests_output, gha_branch_name, pr_number, username) {
  if (!inherits(test_runtests_output, "shinycoreci_runtests")) {
    stop("test_runtests_output must be an object returned by test_runtests()", call. = FALSE)
  }
  # Make the results serializable (result contain conditions, data frames, etc)
  test_runtests_output$result <- vapply(
    test_runtests_output$result,
    function(x) {
      paste0(utils::capture.output({print(x)}), collapse = "\n")
    },
    character(1)
  )

  # Get the app names from the test files
  app_dirs <- dirname(dirname(test_runtests_output$test_path))
  test_runtests_output$app_name <- basename(app_dirs)

  # Attach some other meta-data to the test results
  val <- list(
    results = test_runtests_output,
    platform = platform(),
    r_version = r_version_short(),
    session = unclass(sessioninfo::platform_info()),
    branch_name = app_status_app_branch(app_dirs[1]),
    branch_sha = app_status_app_sha(app_dirs[1]),
    pr_number = pr_number,
    username = username,
    gha_branch_name = gha_branch_name,
    version = 1
  )

  # Root shinycoreci-apps directory
  root_dir <- dirname(dirname(app_dirs))
  # Where the results will be placed
  results_dir <- file.path(root_dir, "_test_results")
  dir.create(results_dir, showWarnings = FALSE)
  results_file <- file.path(results_dir, paste0(gha_branch_name, ".json"))

  cat(jsonlite::toJSON(val, auto_unbox = TRUE), file = results_file)
  invisible(val)
}
