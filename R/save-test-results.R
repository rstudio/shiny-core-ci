#' View (and save) `test_in_ci()` output
#'
#' Use `view_test_results()` to preview test results generated by `save_test_results()`
#' (saving should only ever be done in a GHA workflow).
#'
#' @param ci_output output from `test_in_ci()`.
#' @param gha_branch_name an identifier determined by the GHA workflow
#' @param pr_number the pull request number.
#' @param username the username of the github profile.
#' @inheritParams test_in_ci
#' @rdname test-results
#' @export
save_test_results <- function(ci_output, gha_branch_name, pr_number, username, repo_dir = ".") {
  if (!inherits(ci_output, "shinycoreci_ci_output")) {
    stop("`ci_output` must be an object returned by test_in_ci()", call. = FALSE)
  }
  repo_dir <- normalizePath(repo_dir, mustWork = TRUE)

  # Make the results serializable (result contain conditions, data frames, etc)
  message("TODO-barret; Make results more verbose given testthat output")
  ci_output$result <- vapply(
    ci_output$result,
    function(x) {
      paste0(utils::capture.output({print(x)}), collapse = "\n")
    },
    character(1)
  )

  # Attach some other meta-data to the test results
  val <- list(
    results = ci_output,
    platform = platform(),
    r_version = r_version_short(),
    session = unclass(sessioninfo::platform_info()),
    gha_image_version = gha_image_version(),
    sys_info = paste0(utils::capture.output({write_sysinfo()}), collapse = "\n"),
    branch_name = git_branch(repo_dir),
    branch_sha = git_sha(repo_dir),
    pr_number = pr_number,
    username = username,
    gha_branch_name = gha_branch_name,
    version = 2
  )

  # Where the results will be placed
  results_dir <- file.path(repo_dir, "_test_results")
  dir.create(results_dir, showWarnings = FALSE)
  results_file <- file.path(results_dir, paste0(gha_branch_name, ".json"))

  cat(jsonlite::toJSON(val, auto_unbox = TRUE), file = results_file)
  invisible(val)
}



#' @rdname test-results
#' @export
view_test_results <- function(repo_dir = ".") {
  stop("TODO-barret; Need to have runs on GHA; Need to update app to handle different data structures")

  repo_dir <- normalizePath(repo_dir, mustWork = TRUE)
  if ("shinycoreci" != basename(repo_dir)) {
    warning("This function should be called from the shinycoreci repo")
  }

  Sys.setenv("SHINYCORECI_VIEW_TEST_RESULTS" = repo_dir)
  on.exit({
    Sys.unsetenv("SHINYCORECI_VIEW_TEST_RESULTS")
  }, add = TRUE)
  shiny::shinyAppDir(system.file("view_test_diff", package = "shinycoreci"))
}
