# Cache warming is possible now that cache works for all events using actinos/cache@v2
# https://github.com/actions/cache/issues/63#issuecomment-629422053

name: Warm library cache

on:
  push:
    branches:
      - cache**
      - pak
  # https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions#onschedule
  # https://pubs.opengroup.org/onlinepubs/9699919799/utilities/crontab.html#tag_20_25_16
  schedule:
    - cron:  '0 2 * * 1-5' # every work night before
  repository_dispatch:
    types:
      - all
      - cache

jobs:
  config:
    uses: ./.github/workflows/apps-config.yml

  # macos-release:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.release }}
  #     os: ${{ needs.config.outputs.macos }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}

  # macos-oldrel-1:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel1 }}
  #     os: ${{ needs.config.outputs.macos }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # macos-oldrel-2:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel2 }}
  #     os: ${{ needs.config.outputs.macos }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # macos-oldrel-3:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel3 }}
  #     os: ${{ needs.config.outputs.macos }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # macos-oldrel-4:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel4 }}
  #     os: ${{ needs.config.outputs.macos }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}


  # ubuntu-release:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.release }}
  #     os: ${{ needs.config.outputs.ubuntu }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # ubuntu-oldrel-1:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel1 }}
  #     os: ${{ needs.config.outputs.ubuntu }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # ubuntu-oldrel-2:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel2 }}
  #     os: ${{ needs.config.outputs.ubuntu }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # ubuntu-oldrel-3:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel3 }}
  #     os: ${{ needs.config.outputs.ubuntu }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # ubuntu-oldrel-4:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel4 }}
  #     os: ${{ needs.config.outputs.ubuntu }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}


  # windows-release:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.release }}
  #     os: ${{ needs.config.outputs.windows }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # windows-oldrel-1:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel1 }}
  #     os: ${{ needs.config.outputs.windows }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # windows-oldrel-2:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel2 }}
  #     os: ${{ needs.config.outputs.windows }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # windows-oldrel-3:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel3 }}
  #     os: ${{ needs.config.outputs.windows }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}
  # windows-oldrel-4:
  #   needs: config
  #   uses: ./.github/workflows/apps-cache-os.yml
  #   with:
  #     r-version: ${{ needs.config.outputs.oldrel4 }}
  #     os: ${{ needs.config.outputs.windows }}
  #     cache-version: ${{ needs.config.outputs.cache-version }}






  app-deps:
    runs-on: ${{ needs.config.outputs.ubuntu }}

    name: Update app deps
    needs: config

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: GitHub Pull (PR)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v2
        with:
          # check out the commit sha, not the merged sha. Avoids the "Merge SHA_A into SHA_B" into commits
          ref: ${{ github.event.pull_request.head.sha }}      # # Ref: https://github.com/actions/checkout/pull/115/files#diff-04c6e90faac2675aa89e2176d2eec7d8R203-R209
          fetch-depth: 0
      - name: GitHub Pull (Branch)
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
      - name: Update app pkg deps
        shell: Rscript {0}
        run: |
          source("inst/gha/data-renv-pkgs-update.R")
          update_renv_pkgs()

      - name: Save renv pkgs to Repo
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add ./R
          git commit -m 'Generate renv pkgs (GitHub Actions)' || echo "No renv pkgs changes to commit"
          git push https://${{github.actor}}:${{secrets.GITHUB_TOKEN}}@github.com/${{github.repository}}.git HEAD:${{ github.ref }} || echo "No renv pkgs to push"
